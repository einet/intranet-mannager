<!DOCTYPE html>
<html>
<head>
    <title>查询服务器信息</title>
    <meta charset="utf-8">
    <link href="css/ui-lightness/jquery-ui-1.10.4.css" rel="stylesheet">
    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/jquery-ui-1.10.4.js"></script>
    <script src="js/jquery.base64.js"></script>
    <script type="text/javascript" src="js/json_l.js"></script>
    <script src="../lib/jquery.json-2.3.min.js"></script>
    <script src="../lib/json-to-table.js"></script>
    <link type="text/css" href="jquery.ui.chatbox.css" rel="stylesheet" />
    <script type="text/javascript" src="jquery.ui.chatbox.js"></script>
    <script type="text/javascript" src="js/jquery-cookie.js"></script>
    <script type="text/javascript" src="../lib/jquery.dialogextend.js"></script>
    <script type="text/javascript" src="../lib/map.js"></script>
    <link rel="stylesheet" href="css/ui-darkness/jquery-ui.min.css">
    <link rel="stylesheet" href="menu.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/style.css" media="screen" type="text/css" />
    <style>
        a body {
            background: rgb(255, 255, 255) url(../pic/left.png) repeat-y;
        }

        pre {
            white-space: pre-wrap; /* css-3 */
            white-space: -moz-pre-wrap; /* Mozilla, since 1999 */
            white-space: -pre-wrap; /* Opera 4-6 */
            white-space: -o-pre-wrap; /* Opera 7 */
            word-wrap: break-word; /* Internet Explorer 5.5+ */
        }

        .tailcmd {
            background-color: #c3dde0;
            border-width: 0px;
            width: 80%;
            border-collapse: collapse;
            border-style: solid;
            border-color: #a9c6c9;
        }

        .checkall1 {
            float: right;
            top: 115px;
            margin-top: 5px;
        }

        table.hovertable {
            color: #333333;
            border-width: 1px;
            border-color: #999999;
            border-collapse: collapse;
        }

            table.hovertable th {
                background-color: #c3dde0;
                border-width: 1px;
                padding: 8px;
                border-style: solid;
                border-color: #a9c6c9;
            }

            table.hovertable tr {
                background-color: #d4e3e5;
            }

            table.hovertable td {
                border-width: 1px;
                padding: 8px;
                border-style: solid;
                border-color: #a9c6c9;
            }

        .changecolor {
            color: black;
            border: thin;
            background: yellow;
            font-size: 120%;
            padding: 2px 10px;
            BORDER-BOTTOM-STYLE: dotted;
            BORDER-LEFT-STYLE: dotted;
            BORDER-RIGHT-STYLE: dotted;
            BORDER-TOP-STYLE: dotted;
        }

        .changecolor1 {
            color: black;
            border-bottom: thin dotted black;
        }
    </style>
    <!--[if IE 6]>
    <style>
    body {behavior: url("csshover3.htc");}
    #menu li .drop {background:url("img/drop.gif") no-repeat right 8px;
        </style>
        <![endif]-->
    <script type="text/javascript">
        var showdinfonum = 0;
        var showdinfonum_for = 0;
        //查看爬虫日志
        function clawerlog()
        {
            tmsg = "ls -all /home/apache-tomcat-7.0.37-clawer/logs/catalina.out";

            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host datamaster.olavoice.com" }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                    });
                });
            });
        }
        //查看爬虫状态
        function clawerstatus() {
            tmsg = "curl -s http://172.16.10.16:8088/DataImport/StatusReport";

            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host esurfing" }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                    });
                });
            });
        }
        //查看dell服务器
        function check_mp(opt) {
            tmsg = "./check_mp.sh "+opt;

            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host esurfing" }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                    });
                });
            });
        }
        function showdetailinfo(i) {
            $('#userlistinfo' + i).toggle();
        }
        function getuserchat(user, hostname) {
            var tmsg = "curl -s http://127.0.0.1:8080/olaweb/admin/webadmin/userchat?username=" + user;

            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + hostname }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim(), flag: 0 }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                    });
                });
            });

        }
        function highlight() {
            $(".highlightclass").mouseover(function (event) {
                $(this).css({ "background-color": "yellow", "font-size": "120%" });

            });
            $(".highlightclass").mouseout(function (event) {
                $(this).css({ "background-color": "transparent", "font-size": "100%" });

            });
        }

        String.prototype.trim = function () {
            // 用正则表达式将前后空格
            // 用空字符串替代。
            return this.replace(/(^\s*)|(\s*$)/g, "");
        }
        function choicehost() {
            opendialog('选择对话主机：点击圆圈展开节点，双击文字标签选择对话主机', '<iframe src="../choicehost.html" width="100%" height="100%" frameborder="0"></iframe>', 1);
        }
        function queryuploadfile(id, user, msg) {
            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {
                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('webhostname') }), function (result) {
                    $("#log").append(id + " 查询:<br/> &nbsp;&nbsp;&nbsp;&nbsp;" + msg + "<br/>");
                    $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);
                    $("#chat_div").chatbox("option", "boxManager").addMsg(id, msg);
                    msg = msg.trim();
                    var first_char = msg.charAt(0);

                    msg = msg.replace(/\r\n/g, "\n");
                    var t = msg.split("\n");
                    var tmsg = "";
                    var alertmsg = "";
                    for (i = 0; i < t.length; i++) {
                        if (patt1.test(t[i])) {

                            tmsg += t[i];
                            tmsg += "\n";
                        } else {
                            alertmsg += t[i];
                            alertmsg += "\n";
                        }
                    }
                    if (alertmsg.length > 0) {

                        $("#log").append("<br/>&nbsp;&nbsp;&nbsp;&nbsp;下列命令不允许：" + alertmsg + ",将作为聊天信息发送！<br/> <br/>");
                        $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);
                        $.post("sendmsg.asp", $.toJSON({ sendmsg: alertmsg.trim(), flag: 1 }), function (result) {
                            jmsg = $.parseJSON(result);
                            $("#log").append("&nbsp;&nbsp;&nbsp;&nbsp;收到命令:" + alertmsg + "，正在执行，请稍候！<br/> <br/>");
                            $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);

                            $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                            $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                            if ($.cookie('sethostname').length > 0) {
                                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                                });
                            }
                        });
                    }
                    if (tmsg.length > 0) {
                        $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim(), flag: 0 }), function (result) {
                            jmsg = $.parseJSON(result);
                            $("#log").append("&nbsp;&nbsp;&nbsp;&nbsp;收到命令:" + tmsg + "，正在执行，请稍候！<br/> <br/>");
                            $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);

                            $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                            $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                            if ($.cookie('sethostname').length > 0) {
                                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                                });
                            }
                        });
                    }
                });
            });
        }
        function deletefile(str) {
            $('<div></div>').appendTo('body')
            .html('<div><h6>Yes or No?</h6></div>')
            .dialog({
                modal: true, title: '确认删除', zIndex: 10000, autoOpen: true,
                width: 'auto', resizable: false,
                buttons: {
                    Yes: function () {
                        $.ajax({
                            url: str,
                            type: 'DELETE',
                            success: function (result) {
                                sendolamsg("输入", "", "ls -all ./page/update");
                            }
                        });
                        $(this).dialog("close");
                    },
                    No: function () {

                        $(this).dialog("close");
                    }
                },
                close: function (event, ui) {
                    $(this).remove();
                }
            });
        }
        var patt1;// = new RegExp("^(ls|yum|top|wget|cat|find|tail|date|hostname|tar|free|df|du)( )*.*|^sysctl( )*vm\.drop_caches=1|^killall( )*(find|tail|cat|Waiter|du)( )*|^set( )*.*(host( )*.*)|^\.\/Waiter( )*.*$");
        $.get("/exp.regex", function (data) {
            patt1 = new RegExp(data);
        });
        function sendolamsg(id, user, msg) {
            $("#log").append(id + " 查询:<br/> &nbsp;&nbsp;&nbsp;&nbsp;" + msg + "<br/>");
            $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);
            $("#chat_div").chatbox("option", "boxManager").addMsg(id, msg);
            msg = msg.trim();
            var first_char = msg.charAt(0);

            msg = msg.replace(/\r\n/g, "\n");
            var t = msg.split("\n");
            var tmsg = "";
            var alertmsg = "";
            for (i = 0; i < t.length; i++) {
                if (patt1.test(t[i])) {

                    tmsg += t[i];
                    tmsg += "\n";
                } else {
                    alertmsg += t[i];
                    alertmsg += "\n";
                }
            }
            if (alertmsg.length > 0) {

                $("#log").append("<br/>&nbsp;&nbsp;&nbsp;&nbsp;下列命令不允许：" + alertmsg + ",将作为聊天信息发送！<br/> <br/>");
                $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);
                $.post("sendmsg.asp", $.toJSON({ sendmsg: alertmsg.trim(), flag: 1 }), function (result) {
                    jmsg = $.parseJSON(result);
                    $("#log").append("&nbsp;&nbsp;&nbsp;&nbsp;收到命令:" + alertmsg + "，正在执行，请稍候！<br/> <br/>");
                    $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);

                    $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                    $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                });
            }
            if (tmsg.length > 0) {
                $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim(), flag: 0 }), function (result) {
                    jmsg = $.parseJSON(result);
                    $("#log").append("&nbsp;&nbsp;&nbsp;&nbsp;收到命令:" + tmsg + "，正在执行，请稍候！<br/> <br/>");
                    $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 600);

                    $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                    $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                });
            }
        }
        var last1;
        function opendialog(title, str, style) {
            //dialog options
            $("#olainfo")[0].innerHTML = str;
            if (last1 != undefined && last1 != null) {
                last1.dialog('open');
                $(".ui-dialog-title")[0].innerHTML = title;
                if (style == 1)
                    $("#catinfo").dialogExtend("maximize");
                else
                    $("#catinfo").dialogExtend("restore");
                return;
            }

            var dialogOptions = {
                "title": title,
                "width": 980,
                "height": 640,
                "modal": false,
                "resizable": true,
                "draggable": true
            };
            if ($("#button-cancel").is(":checked")) {
                dialogOptions.buttons = { "Cancel": function () { $(this).dialog("close"); } };
            }
            // dialog-extend options
            var dialogExtendOptions = {
                "closable": true,
                "maximizable": true,
                "minimizable": true,
                "collapsable": true
            };

            // open dialog
            last1 = $("#catinfo").dialog(dialogOptions).dialogExtend(dialogExtendOptions);
            if (style == 1)
                $("#catinfo").dialogExtend("maximize");
            else
                $("#catinfo").dialogExtend("restore");
            return;
        }
        function opendialog(title, str, style) {
            //dialog options
            $("#olainfo")[0].innerHTML = str;
            if (last1 != undefined && last1 != null) {
                last1.dialog('open');
                $(".ui-dialog-title")[0].innerHTML = title;
                if (style == 1)
                    $("#catinfo").dialogExtend("maximize");
                else
                    $("#catinfo").dialogExtend("restore");
                return;
            }

            var dialogOptions = {
                "title": title,
                "width": 980,
                "height": 640,
                "modal": false,
                "resizable": true,
                "draggable": true
            };
            if ($("#button-cancel").is(":checked")) {
                dialogOptions.buttons = { "Cancel": function () { $(this).dialog("close"); } };
            }
            // dialog-extend options
            var dialogExtendOptions = {
                "closable": true,
                "maximizable": true,
                "minimizable": true,
                "collapsable": true
            };

            // open dialog
            last1 = $("#catinfo").dialog(dialogOptions).dialogExtend(dialogExtendOptions);
            if (style == 1)
                $("#catinfo").dialogExtend("maximize");
            else
                $("#catinfo").dialogExtend("restore");
            return;
        }
        function closedialog() {
            $("#catinfo").hide();
            $("#catinfo").dialog("close");
        }
        function ViewDoc(hostname, filename) {
            if (filename.search("/msgdump") > 0)
                tmsg = "cat " + filename + " -A";
            else
                tmsg = "cat " + filename;
            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + hostname, flag: 0 }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                    });
                });
            });


        }
        var tailfname = "";
        var tailhostname = "";
        function TailView(hostname, filename) {

            var dialogOptions = {
                "title": "文件超过2M，建议用tail查看",
                "width": 388,
                "height": 280,
                "modal": true,
                "resizable": false,
                "draggable": true
            };
            if ($("#button-cancel").is(":checked")) {
                dialogOptions.buttons = { "Cancel": function () { $(this).dialog("close"); } };
            }
            // dialog-extend options
            var dialogExtendOptions = {
                "closable": true,
                "maximizable": false,
                "minimizable": false,
                "collapsable": false
            };
            tailfname = filename;
            tailhostname = hostname;
            // open dialog
            $("#dialog111").dialog(dialogOptions).dialogExtend(dialogExtendOptions);

        }
        function openquerykdialog() {

            var dialogOptions = {
                "title": "外网知识库查询",
                "width": 388,
                "height": 280,
                "modal": true,
                "resizable": false,
                "draggable": true
            };
            if ($("#button-cancel").is(":checked")) {
                dialogOptions.buttons = { "Cancel": function () { $(this).dialog("close"); } };
            }
            // dialog-extend options
            var dialogExtendOptions = {
                "closable": true,
                "maximizable": false,
                "minimizable": false,
                "collapsable": false
            };
            // open dialog
            $("#dialog_query_knowledge").dialog(dialogOptions).dialogExtend(dialogExtendOptions);

        }
        function Package(hostname, filename) {
            tmsg = "./package.sh " + filename;
            alert(tmsg);
            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + hostname }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                    });
                });
            });


        }

        function LsDir(hostname, filename) {
            tmsg = filename;

            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + hostname }), function (result) {
                    $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                        if ($.cookie('sethostname').length > 0) {
                            $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {

                            });
                        }

                        $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        $.cookie('webhostname', jmsg.webhostname, { expires: 24 * 60 * 60 });
                    });
                });
            });


        }
        Array.prototype.remove = function (b) {
            var a = this.indexOf(b);
            if (a >= 0) {
                this.splice(a, 1);
                return true;
            }
            return false;
        };
        var TimerID;
        function TimerStart(func, delay) {
            TimerID = window.setInterval(
                                 function () {
                                     if (!func()) {
                                         //window.clearInterval(TimerID);
                                     };
                                 },
                                 delay
                            );
        }
        var lstring = "";
        function ansrusult(result) {

            if (result != lstring) {
                try {
                    jmsg = $.parseJSON(result);
                }
                catch (err) {
                    alert(err);
                }

                if (jmsg.msg.length == 0) {

                    return;
                }
                var infoArray = new Array();
                var catinfores = "";
                var titlestr = "";
                var isSelected = jQuery("#chk1")[0].checked;

                j = 0;
                //合并同样主机，同样cmd的结果
                var msg = new Map();
                for (var i = 0; i < jmsg.msg.length; i++) {
                    var key = jmsg.msg[i].host + jmsg.msg[i].cmd + jmsg.msg[i].ip + jmsg.msg[i].flag;
                    if (msg.get(key) != undefined) {
                        var value = msg.get(key);
                        value.result += jmsg.msg[i].result;
                        msg.put(key, value);
                    } else {
                        msg.put(key, jmsg.msg[i]);
                    }
                }


                var kmsg = new Array();
                var s = "";
                msg.each(function (key, value, index) {
                    kmsg[index] = value;
                });
                j = 0;
                i = 0;
                delete jmsg.msg;
                jmsg.msg = kmsg;
                showdinfonum_for = showdinfonum;
                for (i = 0; i < jmsg.msg.length; i++) {

                    if (!isSelected) {
                        if (jmsg.msg[i].sid != $.cookie('sid')) {
                            continue;
                        }
                    }

                    if (jmsg.msg[i].result.length > 0) {
                        var p = jmsg.msg[i].cmd.split(" ");
                        if (p[0] == "find" && jmsg.msg[i].flag == 1) {
                            infoArray[j] = jmsg.msg[i];
                            infoArray[j].result = infoArray[j].result.replace(/\r\n/g, "\n")
                            var page = infoArray[j].result.split("\n");

                            infoArray[j].result = "";
                            for (var x = 0; x < page.length; x++) {
                                if (page[x].length > 0) {
                                    infoArray[j].result += "<a class=\"highlightclass\"  href='javascript:void(0)' onclick='ViewDoc(\"" + infoArray[j].host + "\",\"" + page[x] + "\")'>" + page[x] + "</a>\n";
                                }
                            }

                            delete infoArray[j].sid;
                            delete infoArray[j].port;
                            delete infoArray[j].flag;
                            j++;

                        } else if ((p[0] == "set" && p[1] == "host") || (p[0] == "clear" && p[1] == "all")) {
                            continue;
                        } else if (p[0] == "ls" && p[1] == "-all" && jmsg.msg[i].flag == 1) {
                            infoArray[j] = jmsg.msg[i];
                            infoArray[j].result = infoArray[j].result.replace(/\r\n/g, "\n")
                            var page = infoArray[j].result.split("\n");

                            infoArray[j].result = "";
                            for (var x = 0; x < page.length; x++) {
                                var dir = page[x].split(/( )+/);
                                if (page[x].length > 0 && dir.length >= 17) {
                                    var iar = page[x].lastIndexOf(dir[16]);
                                    var strtmp = page[x].substr(iar);
                                    if (dir[0].charAt(0) == 'd') {
                                        var path = infoArray[j].cmd.replace(/ls -all/, "").trim();
                                        if (pos = path.search("/logs/olalog") > 0 && strtmp != "." && strtmp != "..")
                                            //打包传递到/mnt/log
                                        {
                                            dir[dir.length - 1] = "<a class=\"highlightclass\"  href='javascript:void(0)' onclick='LsDir(\"" + infoArray[j].host + "\",\"" + infoArray[j].cmd + "/" + strtmp + "\")'>" + strtmp + "</a>&nbsp;&nbsp;<a class=\"highlightclass\"  title='文件放在\\\\fs01.olavoice.com\\share\\olalog &nbsp;&nbsp;目录' href='javascript::void(0)' onclick='Package(\"" + infoArray[j].host + "\",\"" + path + "/" + strtmp + "\")'> 打包 </a>\n";
                                        }
                                        else
                                            dir[dir.length - 1] = "<a  class=\"highlightclass\"  href='javascript:void(0)' onclick='LsDir(\"" + infoArray[j].host + "\",\"" + infoArray[j].cmd + "/" + strtmp + "\")'>" + strtmp + "</a>\n";
                                    } else {
                                        var len = parseInt(dir[dir.length - 9]);
                                        var path = infoArray[j].cmd.replace(/ls -all/, "").trim();
                                        var pos = 0;
                                        if ((pos = path.search(/\/page\/update/)) >= 0 && infoArray[j].host == $.cookie('webhostname')) {
                                            path = path.substr(pos + 5);
                                            dir[dir.length - 1] = strtmp + "&nbsp;&nbsp;<a href='" + path + "/" + encodeURI(strtmp) + "' target='blank'>下载</a>&nbsp;&nbsp;" + "<a class=\"highlightclass\"  href='javascript:void(0)' onclick='deletefile(\"" + path + "/" + encodeURI(strtmp) + "\")'>删除</a>\n";
                                        } else {
                                            if (path == strtmp) {
                                                path = "";
                                            }

                                            if (len < 2 * 1024 * 1024) {
                                                dir[dir.length - 1] = "<a class=\"highlightclass\"  href='javascript:void(0)' onclick='ViewDoc(\"" + infoArray[j].host + "\",\"" + path + "/" + strtmp + "\")'>" + strtmp + "</a>\n";
                                            } else {
                                                dir[dir.length - 1] = "<a class=\"highlightclass\"  href='javascript:void(0)' onclick='TailView(\"" + infoArray[j].host + "\",\"" + path + "/" + strtmp + "\")'>" + strtmp + "</a>\n";
                                            }
                                        }
                                    }
                                    var tlen = page[x].length - strtmp.length;
                                    page[x] = page[x].substr(0, tlen);
                                    infoArray[j].result += page[x] + dir[dir.length - 1];
                                } else {
                                    infoArray[j].result += page[x];
                                }

                            }

                            delete infoArray[j].sid;
                            delete infoArray[j].port;
                            delete infoArray[j].flag;
                            j++;

                        } else if (p[0] == "cat") {
                            titlestr = p[1];
                            str = "<pre>" + unescape(jmsg.msg[i].result) + "</pre>";
                            catinfores += str;
                        } else if (p[0] == "curl" && p[1] == "-s" && p[2] == "http://127.0.0.1:8080/olaweb/admin/webadmin/state") {//获取对话系统用户信息
                            infoArray[j] = jmsg.msg[i];

                            try {
                                var userinfo = $.parseJSON(jmsg.msg[i].result);
                                var userlist = userinfo.userlist;
                                //添加查询用户聊天信息链接
                                var usenum = 0;
                                for (usenum = 0; usenum < userlist.length ; usenum++) {
                                    var name = userlist[usenum].name;
                                    delete userlist[usenum].name;
                                    userlist[usenum].name = "<a class=\"highlightclass\" href='javascript:void(0)' onclick='getuserchat(\"" + name + "\",\"" + jmsg.msg[i].host + "\")'>" + name + "</a>";
                                }
                                var usertotal = userinfo.total;
                                var userTable = ConvertJsonToTable(userlist, 'userlistinfo' + showdinfonum, 'hovertable', '用户信息');
                                if (parseInt(usertotal) > 0) {
                                    userTotal = "<div class=\"tailcmd\">用户总数(<a class=\"highlightclass\" href='javascript:void(0)' onclick='showdetailinfo(" + showdinfonum + ")'>详细</a>)：<div align=\"left\">" + usertotal + "</div></div>"

                                } else {
                                    userTotal = "<div class=\"tailcmd\">用户总数：<div align=\"left\">" + usertotal + "</div></div>"
                                }
                                showdinfonum += 1;
                                infoArray[j].result = "";
                                infoArray[j].result = userTable;
                                infoArray[j].result += userTotal;
                            }
                            catch (err) {

                            }
                            delete infoArray[j].sid;
                            delete infoArray[j].port;
                            delete infoArray[j].flag;
                            j++;
                        } else if (p[0] == "curl" && p[1] == "-s" && (p[2].search(/userchat\?username/) != -1)) {//获取用户对话信息

                            try {
                                var chatinfo = $.parseJSON(jmsg.msg[i].result);
                                var result = json2list(chatinfo);
                                // var chatTable = ConvertJsonToTable(chatinfo, 'chatlistinfo', 'hovertable', '用户对话');

                                titlestr = p[2].substr(62);
                                str = unescape(result);
                                catinfores += str;
                            }
                            catch (err) {
                            }

                        }
                        else {
                            infoArray[j] = jmsg.msg[i];
                            delete infoArray[j].sid;
                            delete infoArray[j].port;
                            delete infoArray[j].flag;
                            j++;
                        }


                    }
                    else if (jmsg.msg[i].result.length == 0 && jmsg.msg[i].cmd.length > 0) {
                        infoArray[j] = jmsg.msg[i];

                        delete infoArray[j].sid;

                        delete infoArray[j].port;
                        delete infoArray[j].flag;
                        j++;
                    }

                }
                if (catinfores.length > 0) {
                    opendialog(titlestr, catinfores, 0);
                }
                if (infoArray.length == 0) {

                    return;
                }
                var cmd = "";
                for (i = 0; i < infoArray.length; i++) {
                    var p = infoArray[i].cmd.split(" ");
                    if (cmd != infoArray[i].cmd)
                        cmd += infoArray[i].cmd;
                    if (p[0] == "tail" || !patt1.test(infoArray[i].cmd)) {
                        delete infoArray[i].cmd;
                        continue;
                    } else {
                        delete infoArray[i].cmd;
                        var r_array = infoArray[i].result.split("\n");
                        infoArray[i].result = "";
                        for (bluk = 0; bluk < r_array.length; bluk++) {
                            infoArray[i].result += "<div class=\"changecolor1\">" + r_array[bluk] + "</div>";
                        }
                    }
                }
                var jsonHtmlTable = ConvertJsonToTable(infoArray, 'resid', 'hovertable', ' 服务信息');
                var gcmd = "<div class=\"tailcmd\">运行命令【" + infoArray.length + "】(双击选择执行命令)：<div class=\"clickcmd\" align=\"center\">" + cmd + "</div></div>"
                $("#log").append($.cookie('sid') + " 结果:<br/> &nbsp;&nbsp;&nbsp;&nbsp;<pre>" + jsonHtmlTable + gcmd + "</pre><br/>");
                $("#log").animate({ scrollTop: $("#log").prop("scrollHeight") }, 800);
                $('.clickcmd').dblclick(function (e) {
                    $(".ui-widget-content.ui-chatbox-input-box.ui-corner-all").val(this.textContent);
                });
                for (i = showdinfonum_for; i < showdinfonum; i++) {
                    $('#userlistinfo' + i).hide();
                }
                highlight();
                lstring = result;
            }
        }
        function resee() {
            TimerStart(
                      function () {
                          var isScroll = jQuery("#chk2")[0].checked;
                          $(document).attr("title", "查询主机:" + $.cookie('sethostname'));
                          if (isScroll) {
                              window.clearInterval(TimerID);
                              return;
                          }
                          $.post("/chat/recvmsg.asp", $.toJSON({ sid: $.cookie('sid') }), function (result) {
                              ansrusult(result);
                          });
                      },
                  3000
                );

        }
        var Browser = new Object();
        Browser.isMozilla = (typeof document.implementation != 'undefined') && (typeof document.implementation.createDocument != 'undefined') && (typeof HTMLDocument != 'undefined');
        Browser.isIE = window.ActiveXObject ? true : false;
        Browser.isFirefox = (navigator.userAgent.toLowerCase().indexOf("firefox") != -1);
        Browser.isSafari = (navigator.userAgent.toLowerCase().indexOf("safari") != -1);
        Browser.isOpera = (navigator.userAgent.toLowerCase().indexOf("opera") != -1);


        function startrecv() {
            if (Browser.isFirefox) {
                resee();
            } else {
                if (typeof (EventSource) !== "undefined") {
                    var source = new EventSource("/chat/recvmsg.tes");

                    source.onmessage = function (result) {

                        $(document).attr("title", "查询主机:" + $.cookie('sethostname'));
                        var isScroll = jQuery("#chk2")[0].checked;
                        if (isScroll) {
                            event.target.close();
                        }
                        ansrusult(result.data);
                    };
                }
                else {
                    resee();

                }
            }
        }

        $(document).ready(function () {
            $("#dialog111").hide();
            $("#dialog112").hide();
            $("#dialog_query_knowledge").hide();
            $("#chk2").on("click", function () {
                var isScroll = jQuery("#chk2")[0].checked;
                if (!isScroll) {
                    startrecv();
                }

            });
            screen_height = $(document).height();
            $("#log").height(screen_height - 50);


            $("#chat_div").dblclick(function (e) {

                if (e.target.innerText == undefined) {
                    box.context.activeElement.value = e.target.innerHTML;
                } else {
                    box.context.activeElement.value = e.target.innerText;
                }
            });
            var box = null;

            function openchatroom() {
                if (box) {
                    box.chatbox("option", "boxManager").toggleBox();
                }
                else {

                    box = $("#chat_div").chatbox({
                        id: "输入",
                        user: { key: "value" },
                        title: "ctrl+enter发送:",
                        messageSent: function (id, user, msg) {
                            sendolamsg(id, user, msg);

                        }
                    });


                }
                $('.ui-widget.ui-corner-top.ui-chatbox').draggable({ axis: "y" });
            }
            $("input[type='button']").click(function (event, ui) {
                openchatroom();

            });
            $("#db_update_btn").click(function (event, ui) {
                if ($("#db_update_text")[0].value == "") {
                    alert("请输入需要更新的内容");
                } else {
                    var msg = 'curl -s http://127.0.0.1:8080/olaweb/admin/fresh/updatecache?part=' + $("#db_update_text")[0].value;


                    $('<div></div>').appendTo('body')
                         .html('<div><h6>Yes or No?</h6></div>')
                         .dialog({
                             modal: true, title: '确认', zIndex: 10000, autoOpen: true,
                             width: 'auto', resizable: false,
                             buttons: {
                                 Yes: function () {
                                     $("#db_update_text")[0].value = "";
                                     $(this).dialog("close");
                                     sendolamsg("输入", "", msg);
                                 },
                                 No: function () {

                                     $(this).dialog("close");
                                 }
                             },
                             close: function (event, ui) {
                                 $(this).remove();
                             }
                         });
                }
            });
            $("#searchfile").click(function (event, ui) {
                var msg = 'find /home/ -name "*' + $("#searchfilename")[0].value + '*" -size +1';
                sendolamsg("输入", "", msg);
            });

            $('#searchfilename').keypress(function (e) {
                if (e.which == 13) {
                    var msg = 'find /home/ -name "*' + $("#searchfilename")[0].value + '*" -size +1';
                    sendolamsg("输入", "", msg);
                }
            });

            $("#tailsubmit").click(function (event, ui) {


                var isTail_f = jQuery("#tail_f")[0].checked;
                if (isTail_f) {
                    tmsg = "tail -n " + $("#startline")[0].value + " " + tailfname + " -f ";
                } else {
                    tmsg = "tail -n " + $("#startline")[0].value + " " + tailfname;
                }
                var grepstr = $("#grepchar")[0].value;
                var grepline;
                if ($("#grepline")[0].value == "" || $("#grepline")[0].value == "0")
                    grepline = 1;
                else
                    grepline = $("#grepline")[0].value;
                if (grepstr != "") {
                    if (isTail_f) {
                        tmsg = "tail -n " + $("#startline")[0].value + " " + tailfname + " -f|grep '" + grepstr + "' -a" + " -C " + grepline;
                    } else {
                        tmsg = "tail -n " + $("#startline")[0].value + " " + tailfname + "|grep '" + grepstr + "' -a" + " -C " + grepline;
                    }

                }
                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                    $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + tailhostname }), function (result) {
                        $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                            if ($.cookie('sethostname').length > 0) {
                                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {
                                    $("#dialog111").dialog("close");;
                                });
                            }

                            $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        });
                    });
                });
            });


            //knowledgesubmit
            // curl  -s  http://172.16.10.42/KnowledgeService2/queryv2?keyword1=%E6%AD%A6%E6%B1%89\&keyword2=.com
            function k_submit() {
                var key1 = $("#keyword1")[0].value;
                var key2 = $("#keyword2")[0].value;
                tmsg = "curl -s http://172.16.10.42/KnowledgeService2/queryv2?keyword1=" + key1 + "\\&keyword2=" + key2;

                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host clear" }), function (result) {

                    $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host knowledge" }), function (result) {
                        $.post("sendmsg.asp", $.toJSON({ sendmsg: tmsg.trim() }), function (result) {
                            if ($.cookie('sethostname').length > 0) {
                                $.post("/chat/sendmsg.asp", $.toJSON({ sendmsg: "set host " + $.cookie('sethostname') }), function (result) {
                                    $("#dialog_query_knowledge").dialog("close");;
                                });
                            }

                            $.cookie('sid', jmsg.id, { expires: 24 * 60 * 60 });
                        });
                    });
                });
            }
            $("#knowledgesubmit").click(function (event, ui) {
                k_submit();
            });

            $('#keyword1').keydown(function (e) {
                var key = e.which;
                if (key == 13) {
                    k_submit();
                }
            });
            $('#keyword2').keydown(function (e) {
                var key = e.which;
                if (key == 13) {
                    k_submit();
                }
            });
            openchatroom();
            startrecv();
        });

    </script>

</head>
<body>
    <div id="catinfo"><pre id="olainfo"></pre></div>
    <ul id="menu">
        <li>
            <a href="#" class="drop">介绍</a>
            <div class="dropdown_2columns">
                <div class="col_1_2">
                    <h3>欢迎使用Linux集群服务管理系统 !</h3>
                </div>
                <div class="col_1_2">
                    <ul>
                        <li>查询集群服务状况.</li>
                        <li>查询应用服务状况.</li>
                        <li>查阅服务日志信息.</li>
                    </ul>
                </div>
            </div>
        </li>
        <li><a href="javascript:void(0)" onclick='choicehost()'>主机选择</a>
        <li class="menu_right">

        </li>
        <li>
            <a href="#" class="drop">功能选择</a>
            <div class="dropdown_5columns">
                <div class="col_1">
                    <h3>浏览目录</h3>
                    <ul>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","ls -all /home")'>用户目录</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","ls -all /var/log")'>系统日志</a></li>
                        <li><a href="javascript:void(0)" onclick='queryuploadfile("输入","","ls -all ./page/update")'>上传文件</a></li>
                    </ul>
                </div>
                <div class="col_1">
                    <h3>服务查询</h3>
                    <ul>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","free -m")'>内存</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","top -bn 1")'>进程</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","df -h")'>磁盘</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","date")'>时间</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入", "", "curl -s http://127.0.0.1:8080/olaweb/admin/webadmin/state")'>在线用户</a></li>
                    </ul>
                </div>
                <div class="col_1">
                    <h3>对话系统日志</h3>
                    <ul>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","ls -all /home/dlstest/apache-tomcat-7.0.37/logs")'>Tomcat日志</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","ls -all /home/dlstest/apache-tomcat-7.0.37/logs/catalina.out")'>catalina.out</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","ls -all /home/dlstest/apache-tomcat-7.0.37/logs/olalog")'>DS日志</a></li>
                    </ul>
                </div>
                <div class="col_1">
                    <h3>其他查询</h3>
                    <ul>
                        <li><a href="javascript:void(0)" onclick='openquerykdialog()'>知识库查询</a></li>
                        <br />
                        <li><a href="javascript:void(0)" onclick='clawerlog()'>爬虫日志</a></li>
                        <li><a href="javascript:void(0)" onclick='clawerstatus()'>爬虫状态</a></li>
                    </ul>
                </div>
                <div class="col_1">
                    <h3>辅助功能：</h3>
                    <p>
                        终止操作：停止本会话提交的相关查询命令，如要继续查询，请点击"启动查询"
                    </p>
                    <ul>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","block")'>终止查询</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","unblock")'>启动查询</a></li>
                        <!--li><a href="javascript:void(0)" onclick='sendolamsg("输入","","killall find")'>关闭find</a></!--li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","killall tar")'>停止日志文件打包</a></li-->
                        <!--li><a href="javascript:void(0)" alt="停止已经提交的所有操作，系统不再处理结束的请求" onclick='sendolamsg("输入","","unlock")'>停止服务</a></li>
                        <li><a href="javascript:void(0)" alr="恢复服务,处理接受的请求" onclick='sendolamsg("输入","","lock")'>启动服务</a></li-->
                        <li>停止消息滚动<input type="checkbox" id="chk2" class="checkall1" value="1" alt="可以看到系统内其他人请求的消息" /></li>
                        <li>查看所有消息<input type="checkbox" id="chk1" class="checkall1" value="1" alt="可以看到系统内其他人请求的消息" /></li>
                        <li><input type="button" id="chk1" value="打开聊天框" alt="打开聊天框" /></li>
                    </ul>
                </div>
            </div>
        </li>
        <li>
            <a href="#" class="drop">Dell服务器监控</a>
            <div class="dropdown_2columns">
                <div class="col_1_2">
                    <h3>检查服务器一下指标：disk, fan, health, info, redundancy, temperature</h3>
                </div>
                <div class="col_1_2">
                    <ul>
                        <li><a href="javascript:void(0)" onclick='check_mp("disk")'>磁盘</a></li>
                        <li><a href="javascript:void(0)" onclick='check_mp("fan")'>风扇</a></li>
                        <li><a href="javascript:void(0)" onclick='check_mp("health")'>健康</a></li>
                        <li><a href="javascript:void(0)" onclick='check_mp("info")'>服务TAG</a></li>
                        <li><a href="javascript:void(0)" onclick='check_mp("redundancy")'>电源</a></li>
                        <li><a href="javascript:void(0)" onclick='check_mp("temperature")'>温度</a></li>
                </div>
             
            </div>
        </li>
        <li class="menu_right">
            <a href="../upload/index.html" target=blank>文件上传</a></a>
        </li>
        <li class="menu_right">
            <a href="#" class="drop">系统文件搜索</a><!-- Begin 3 columns Item -->
            <div class="dropdown_4columns align_right">
                <!-- Begin 3 columns container -->
                <div class="col_1_4">
                    <section class="webdesigntuts-workshop">
                        <form action="javascript:void(0)" method="">
                            <input id="searchfilename" type="search" placeholder="请输入需要查找的内容?">
                            <button id="searchfile">Search</button>
                        </form>
                    </section>
                </div>
                <div class="col_1_4"><br><br><br><br><br><br><br></div>
            </div>
        </li>
        <li class="menu_right">
            <a href="#" class="drop">数据库更新</a>
            <div class="dropdown_2columns">
                <div class="col_1_2">
                    <h3>首先选取服务器，然后点击下列链接，更新系统相关配置 !</h3>
                </div>
                <div class="col_1_2">
                    <ul>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","curl -s http://127.0.0.1:8080/olaweb/admin/fresh/updatecache?part=phoneregx")'>phoneregx</a></li>
                        <li><a href="javascript:void(0)" onclick='sendolamsg("输入","","curl -s http://127.0.0.1:8080/olaweb/admin/fresh/updatecache?part=clientid")'>clientid</a></li>
                        <!--li><a href="javascript:void(0)" onclick='sendolamsg("输入","","curl -s http://127.0.0.1:8080/olaweb/admin/fresh/updatecache?part=all")'>all</a></li-->
                    </ul>
                </div>
                <div class="col_1_2">
                    <h3>自定义更新</h3>
                    <form action="javascript:void(0)" method="">
                        <input id="db_update_text" type="search" placeholder="请输入更新的内容">
                        <button id="db_update_btn">更新</button>
                    </form>
                </div>
            </div>
        </li>
    </ul>
    <div id="chat_div">
    </div>
    <div id="log" style="border:0px solid white;width:100%;height:800px;overflow:auto">
    </div>
    <div id="dialog111">
        <h3>
            请输入参数</h2>
            <label>尾部行数</label>
            <input type="text" style="background-color:black" id="startline" value="1000"></input><br>
            <label>过滤字符</label>
            <input type="text" style="background-color:black" id="grepchar"></input><br>
            <label>后续行数</label>
            <input type="text" style="background-color:black" id="grepline"></input><br>
            tail 带参数-f，滚动查询
            <input type="checkbox" id="tail_f" value="1" alt="" /><br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input style="background-color:black" id="tailsubmit" type="submit" value="确定" align="right">
    </div>

    <div id="dialog_query_knowledge">
        <h3>
            请输入参数</h2>
            <label>关键字1</label>
            <input type="text" style="background-color:black" id="keyword1"></input><br>
            <label>关键字2</label>
            <input type="text" style="background-color:black" id="keyword2"></input><br>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input style="background-color:black" id="knowledgesubmit" type="submit" value="查询" align="right">
    </div>
</body>
</html>



